<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Adicionar Teste</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
</head>
<body class="container py-4">
  <div class="position-absolute top-0 start-0 m-3">
    <button class="btn btn-outline-secondary" onclick="window.history.back()">← Voltar</button>
  </div>

  <h1 class="text-center mb-4">Adicionar / Editar Teste</h1>

  <form id="formTeste" class="mb-5">
    <input type="hidden" id="idteste" name="idteste" />

    <div class="mb-3">
      <label for="descricao" class="form-label">Nome</label>
      <input type="text" id="descricao" name="descricao" class="form-control" required />
    </div>

    <div class="mb-3">
      <label for="precocompra" class="form-label">Preço de Compra (€)</label>
      <input type="number" step="0.01" id="precocompra" name="precocompra" class="form-control" required />
    </div>

    <div class="mb-3">
      <label for="idtipoteste" class="form-label">Tipo de Teste</label>
      <select id="idtipoteste" name="idtipoteste" class="form-select" required>
        <option value="">-- Selecione um tipo --</option>
      </select>
    </div>

    <div class="mb-3">
      <label for="tempominimogestacao" class="form-label">Tempo Mínimo de Gestação (dias)</label>
      <input type="number" id="tempominimogestacao" name="tempominimogestacao" class="form-control" />
    </div>

    <div class="mb-3">
      <label for="temporesposta" class="form-label">Tempo de Resposta (dias)</label>
      <input type="number" id="temporesposta" name="temporesposta" class="form-control" />
    </div>

    <button type="submit" class="btn btn-primary">Guardar</button>
    <button type="reset" class="btn btn-secondary">Limpar</button>
  </form>

  <script>
    const form = document.getElementById('formTeste');

    async function carregarTiposTeste() {
      try {
        const res = await fetch('/tiposteste');
        const tipos = await res.json();

        const select = document.getElementById('idtipoteste');
        select.innerHTML = '<option value="">-- Selecione um tipo --</option>';
        tipos.forEach(t => {
          const option = document.createElement('option');
          option.value = t.idtipoteste;
          option.textContent = t.nomept;
          select.appendChild(option);
        });
      } catch (err) {
        console.error('Erro ao carregar tipos de teste:', err);
        alert('Erro ao carregar tipos de teste');
      }
    }

    async function carregarTesteParaEditar() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      if (!id) return;

      try {
        const res = await fetch(`/testes/${id}`);
        if (!res.ok) throw new Error('Erro ao buscar teste');

        const t = await res.json();
        form.idteste.value = t.idteste;
        form.nome.value = t.nome || '';
        form.precocompra.value = t.precocompra || '';
        form.idtipoteste.value = t.idtipoteste || '';
        form.tempominimogestacao.value = t.tempominimogestacao || '';
        form.temporesposta.value = t.temporesposta || '';
      } catch (err) {
        console.error('Erro ao carregar teste para edição:', err);
        alert('Erro ao carregar dados do teste');
      }
    }

    form.onsubmit = async (e) => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(form));
      data.precocompra = parseFloat(data.precocompra);
      data.tempominimogestacao = parseInt(data.tempominimogestacao) || null;
      data.temporesposta = parseInt(data.temporesposta) || null;

      const method = data.idteste ? 'PUT' : 'POST';
      const url = data.idteste ? `/testes/${data.idteste}` : '/testes';

      if (!data.idteste) delete data.idteste;

      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (!res.ok) {
        const erro = await res.json();
        alert('Erro: ' + JSON.stringify(erro));
        return;
      }

      alert('Teste guardado com sucesso!');
      form.reset();
      window.location.href = '/menu.html'; // ou outra página desejada
    };

    window.onload = async () => {
      await carregarTiposTeste();
      await carregarTesteParaEditar();
    };
  </script>
</body>
</html>
