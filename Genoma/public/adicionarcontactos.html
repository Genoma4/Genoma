<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Adicionar / Editar Contacto</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="container py-4">
  <button class="btn btn-outline-secondary mb-3" onclick="window.location.href='contactos.html'">← Voltar</button>
  <h2 class="text-center mb-4" id="tituloPag">Novo Contacto</h2>

  <form id="form">
    <ul class="nav nav-tabs mb-3" id="contactTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="ident-tab" data-bs-toggle="tab" data-bs-target="#identificacao" type="button" role="tab">Identificação</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="gravidez-tab" data-bs-toggle="tab" data-bs-target="#gravidez" type="button" role="tab">Gravidez</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="colheita-tab" data-bs-toggle="tab" data-bs-target="#colheita" type="button" role="tab">Colheita</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="fact-tab" data-bs-toggle="tab" data-bs-target="#facturacao" type="button" role="tab">Faturação</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="marketing-tab" data-bs-toggle="tab" data-bs-target="#marketing" type="button" role="tab">Marketing</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="notas-tab" data-bs-toggle="tab" data-bs-target="#notas" type="button" role="tab">Notas</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="anexos-tab" data-bs-toggle="tab" data-bs-target="#anexos" type="button" role="tab">Anexos</button>
      </li>
    </ul>

    <div class="tab-content" id="contactTabContent">
      <div class="tab-pane fade show active" id="identificacao" role="tabpanel">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Nome</label>
            <input name="nome" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">Email</label>
            <input name="email" type="email" class="form-control">
          </div>

          <div class="col-md-6">
            <label class="form-label">Morada</label>
            <input name="morada" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">Morada 2</label>
            <input name="morada2" class="form-control">
          </div>

          <div class="col-md-4">
            <label class="form-label">Código Postal</label>
            <input name="codigopostal" class="form-control">
          </div>
          <div class="col-md-4">
            <label class="form-label">Localidade</label>
            <input name="localidade" class="form-control">
          </div>
          <div class="col-md-4">
            <label class="form-label">Telefone</label>
            <input name="telefone" class="form-control">
          </div>

          <div class="col-md-4">
            <label class="form-label">Telemóvel</label>
            <input name="telemovel" class="form-control">
          </div>
          <div class="col-md-4">
            <label class="form-label">Data de Nascimento</label>
            <input name="datanascimento" type="date" class="form-control">
          </div>
          <div class="col-md-4">
            <label class="form-label">NIF</label>
            <input name="nif" class="form-control">
          </div>

          <div class="col-md-6">
            <label class="form-label">BIC / IBAN</label>
            <input name="bicc" class="form-control">
          </div>

          <div class="col-md-3">
            <label class="form-label">Altura (cm)</label>
            <input name="altura" type="number" class="form-control">
          </div>
          <div class="col-md-3">
            <label class="form-label">Peso (kg)</label>
            <input name="peso" type="number" class="form-control">
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="gravidez" role="tabpanel">
        <div class="row g-3 mt-3">
          <div class="col-md-6">
            <label class="form-label">Dias de Gravidez desde o registo</label>
            <input name="diasgravidezdaregisto" type="number" class="form-control">
          </div>
          <div class="col-md-6 d-flex align-items-end">
            <div class="form-check me-4">
              <input class="form-check-input" type="checkbox" name="gemelar" id="gemelar">
              <label class="form-check-label" for="gemelar">Gemelar</label>
            </div>
            <div class="form-check me-4">
              <input class="form-check-input" type="checkbox" name="quersabersexo" id="quersabersexo">
              <label class="form-check-label" for="quersabersexo">Quer saber o sexo</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="repeticao" id="repeticao">
              <label class="form-check-label" for="repeticao">Repetição</label>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="colheita" role="tabpanel">
        <div class="row g-3 mt-3">
          <div class="col-md-4">
            <label class="form-label">Posto de Colheita</label>
            <select name="idpostocolheita" id="selPosto" class="form-select"></select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Período de Colheita</label>
            <select name="idperiodocolheita" id="selPeriodo" class="form-select"></select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Tipo de Fertilização</label>
            <select name="idtipofertilizacao" id="selFert" class="form-select"></select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Data de Registo</label>
            <input name="dataregisto" type="date" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">Médico</label>
            <select name="idmedico" id="selMedico" class="form-select"></select>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="facturacao" role="tabpanel">
        <div class="row g-3 mt-3">
          <div class="col-md-4">
            <label class="form-label">Número da Fatura</label>
            <input name="numerofactura" class="form-control">
          </div>
          <div class="col-md-4">
            <label class="form-label">Data da Fatura</label>
            <input name="datafactura" type="date" class="form-control">
          </div>
          <div class="col-md-4">
            <label class="form-label">Valor da Fatura (€)</label>
            <input name="valorfactura" type="number" step="0.01" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">Referência MB</label>
            <input name="referenciamultibanco" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">Data de Pagamento</label>
            <input name="datapagamento" type="date" class="form-control">
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="marketing" role="tabpanel">
        <div class="row g-3 mt-3">
          <div class="col-md-4">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="naoenviarsms" id="naoenviarsms">
              <label class="form-check-label" for="naoenviarsms">Não enviar SMS</label>
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="naoenviarmail" id="naoenviarmail">
              <label class="form-check-label" for="naoenviarmail">Não enviar Email</label>
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="servicoexpresso" id="servicoexpresso">
              <label class="form-check-label" for="servicoexpresso">Serviço Expresso</label>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="notas" role="tabpanel">
        <div class="mb-3">
          <label class="form-label">Notas</label>
          <textarea name="notas" class="form-control" rows="4"></textarea>
        </div>
      </div>
      <div class="tab-pane fade" id="anexos" role="tabpanel">
        <!-- Simulação ou upload de anexos -->
        <p>Gestão de anexos virá aqui.</p>
      </div>
    </div>

    <div class="d-flex justify-content-end mt-4">
      <button type="reset" class="btn btn-secondary me-2">Limpar</button>
      <button type="submit" class="btn btn-primary">Guardar</button>
    </div>
  </form>

  <script>
const form = document.getElementById('form');
const idCont = new URLSearchParams(location.search).get('id');

const intOrNull   = v => v && v !== '' ? parseInt(v, 10) : null;
const floatOrNull = v => v && v !== '' ? parseFloat(v) : null;
const dateOrNull  = v => v && v !== '' ? v : null;

const getJSON = res => res.ok ? res.json() : res.text().then(t => Promise.reject(t));

async function carregarContacto() {
  if (!idCont) return;
  document.getElementById('tituloPag').textContent = 'Editar Contacto';

  const contacto = await fetch(`/contactos/${idCont}`).then(getJSON);
  Object.entries(contacto).forEach(([k, v]) => {
    if (form[k]) {
      if (form[k].type === 'checkbox') form[k].checked = !!v;
      else form[k].value = v ?? '';
    }
  });
}

form.addEventListener('submit', async e => {
  e.preventDefault();
  const f = new FormData(form);
  const data = Object.fromEntries(f.entries());

  // conversões
  ['idpais', 'idmedico', 'idpostocolheita', 'idperiodocolheita', 'idtipofertilizacao', 'idmotivoanulacao', 'altura', 'peso']
    .forEach(k => data[k] = intOrNull(data[k]));
  ['valorfactura'].forEach(k => data[k] = floatOrNull(data[k]));
  ['datanascimento', 'dataregisto', 'datafactura', 'datapagamento']
    .forEach(k => data[k] = dateOrNull(data[k]));

  // checkboxes
  ['gemelar','quersabersexo','repeticao','naoenviarsms','naoenviarmail','servicoexpresso']
    .forEach(k => data[k] = form[k]?.checked || false);

  const method = idCont ? 'PUT' : 'POST';
  const url = idCont ? `/contactos/${idCont}` : '/contactos';

  const resp = await fetch(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });

  if (!resp.ok) {
    alert('Erro: ' + await resp.text());
    return;
  }

  alert('Guardado com sucesso!');
  location.href = 'contactos.html';
});

carregarContacto();
</script>

</body>
</html>
